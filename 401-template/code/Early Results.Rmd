---
title: "DA 401 Early Results"
author: "Calvin Burzynski"
date: "2025-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(readr)
library(ggplot2)
library(fixest)
library(janitor)

#load in ipums (acs) dataset
ipums <- read.csv("../../../usa_00003.csv.gz")

#load minimum wage DOL data
min_wage_data <- read.csv("..//..//..//Minimum Wage from DOL 2018-2024.csv")

#load monthly unemployment rate data
unemployment_rate_data <- read.csv("..//..//..//State unemployment rates over the last 10 years, seasonally adjusted_BLS.csv")

gdp_income <- read.csv("..//..//..//State Annual Summary Statistics GDP Income.csv", skip = 3)
```

```{r}
#filter for poverty status
ipums %>%
  distinct(POVERTY) %>%
  arrange(POVERTY) #investigating values of poverty 

ipums_poverty <- ipums %>%
  filter(EMPSTAT == 1, UHRSWORK >= 35, WKSWORK2 >= 6, AGE >= 18, AGE <= 64) %>%
  mutate(
    in_poverty = ifelse(OFFPOV == 1, 1, 0), 
    valid = ifelse(OFFPOV %in% c(0, 1), 1, 0)
  ) %>%
  filter(valid == 1) %>%
  group_by(STATEFIP, YEAR) %>%
  summarise(
    poverty_rate = weighted.mean(in_poverty, w = PERWT, na.rm = TRUE),
    pop_weight = sum(PERWT, na.rm = TRUE), 
    .groups = 'drop'
  )
#pop_weight represents the estimated total number of individuals represented by the ACS sample in that state-year 


```


```{r}
min_wage_long <- min_wage_data %>%
  rename_with(~str_remove(., "^X"), starts_with("X")) %>% #cleans columns with 'X' prefix
  pivot_longer(
    cols = all_of(as.character(2018:2024)),
    names_to = "YEAR",
    values_to = "min_wage"
  ) %>%
  mutate(
    YEAR = as.numeric(YEAR)
  ) %>%
  filter(between(YEAR, 2018, 2023))
```

```{r}
#pivot unemplyoment rate data to long format

#replaces "." with "-" for month and year columns
unemployment_rate_rename <- unemployment_rate_data %>%
  rename_with(~ str_replace_all(.x, "\\.", "-"), .cols = -State)

#helps match structure of month-year columns 
month_cols <- grep("^[A-Za-z]{3}-\\d{2,4}$", names(unemployment_rate_rename), value = TRUE)

unemployment_numeric <- unemployment_rate_rename %>%
  mutate(across(all_of(month_cols), ~ parse_number(as.character(.))))

unemployment_long <- unemployment_numeric %>%
  pivot_longer(
    cols = all_of(month_cols), 
    names_to = "date_string", 
    values_to = "unemployment_rate"
  ) %>%
  mutate(
    date = my(date_string), 
    YEAR = year(date)
  ) %>%
  filter(!is.na(date), between(YEAR, 2018, 2023)) %>%
  group_by(State, YEAR) %>%
  summarise(unemployment_rate = mean(unemployment_rate, na.rm = TRUE), .groups = 'drop')
```

```{r}
gdp_income_long <- gdp_income %>%
  rename_with(~str_remove(., "^X"), starts_with("X")) %>%
  filter(LineCode %in% c(1, 8)) %>%
  select(GeoName, GeoFips, LineCode, all_of(as.character(2018:2023))) %>%
  pivot_longer(
    cols = all_of(as.character(2018:2023)),
    names_to = "YEAR",
    values_to = "value"
  ) %>%
  mutate(
    YEAR = as.integer(YEAR), 
    value = parse_number(as.character(value)),
    STATEFIP = as.integer(parse_number(as.character(GeoFips)) / 1000L), 
    var = case_when(
      LineCode == 1 ~ "real_gdp", 
      LineCode == 8 ~ "real_per_capita_income"
    )
  ) %>%
  filter(STATEFIP >0) %>%
  select(STATEFIP, YEAR, var, value, GeoName) %>%
  pivot_wider(names_from = var, values_from = value) %>%
  mutate(real_gdp = as.numeric(real_gdp), 
         real_per_capita_income = as.numeric(real_per_capita_income)
         )
```




```{r}
unemployment_with_fips <- unemployment_long %>%
  left_join(
    min_wage_long %>%
      distinct(State, StateFIPS) %>%
      transmute(State, STATEFIP = as.integer(StateFIPS)), 
    by = "State"
  ) %>%
  transmute(STATEFIP, YEAR, unemployment_rate)
```

```{r}
#assign states names
state_names <- no_doc %>%
  distinct(STATEFIP, GeoName)


  
#merging datasets
panel_data <- ipums_poverty %>%
  left_join(min_wage_long %>% transmute(STATEFIP = as.integer(StateFIPS), YEAR, min_wage), 
            by = c("STATEFIP", "YEAR")) %>%
  left_join(unemployment_with_fips, by = c("STATEFIP", "YEAR")) %>%
  left_join(state_names, by = c("STATEFIP"))


#filter out district of columbia
panel_clean <- panel_data %>%
  filter(STATEFIP != 11)

#summary of data
summary(panel_data)

```



```{r}
plot_data <- initial_panel %>%
  group_by(State.x) %>%
  mutate(Group = ifelse(any(min_wage > 7.25), "Treated States", "Control States")) %>%
  ungroup()

ggplot(plot_data, aes(x = YEAR, y = poverty_rate, color = Group)) + 
  stat_summary(fun = "mean", geom = "line", size = 1.2) + 
  stat_summary(fun = "mean", geom = "point", size = 3) + 
  labs(title = "Poverty Rate Trends for Low-Wage Workers (2018-2023)", 
       subtitle = "Visual check for the parallel trends assumption", 
       x = "Year", 
       y = "Average Poverty Rate", 
       color = "State Group") + 
  theme_minimal()
```

The yielded plot from the code is a visualization check for the parallel trends assumption. For Difference-in-Differences to be valid, it must be assumed that the "Treated" and "Control" states would have followed similar trends if no minimum wage increases had occurred. The plot essentially shows this. A large spike in poverty for both groups in 2020 is a clear and expected result, potentially reflecting the economic disruption of the covid-19 pandemic. After 2020/21, there appeared to be a decline in poverty for both groups. The hope is that the analysis going forward will answer the following question: "did the poverty rate in the treated states fall more than it did in the control states, after accounting for the baseline differences and 2020 shock?"

```{r}
ggplot(initial_panel, aes(x = poverty_rate)) + geom_histogram(bins = 30, fill = "blue", color = "black") + labs(title = "Distribution of State-Year Poverty Rates")

ggplot(initial_panel, aes(x = unemployment_rate, y = poverty_rate)) + geom_point()
```




```{r}
#binary variable to determine if state was treated
panel_data_clean <- initial_panel %>%
  mutate(is_treated = ifelse(min_wage > 7.25, 1, 0))

#clean names to make regression smoother
#drop district of columbia; statefips = 11

panel_data_clean2 <- panel_data_clean %>%
  clean_names() %>%
  filter(statefip != 11) %>%
  select(statefip, year, poverty_rate, state_x, min_wage, unemployment_rate, real_gdp, real_per_capita_income) %>%
  rename(state = state_x) %>%
  mutate(
    across(c(poverty_rate, min_wage, unemployment_rate, real_gdp, real_per_capita_income), 
           ~ parse_number(as.character(.)))
  )
panel_data_clean2 <- panel_data_clean2 %>%
  mutate(real_gdp_mil = real_gdp / 1e6)

preliminary_model <- feols(
  poverty_rate ~ min_wage + unemployment_rate + real_gdp_mil + real_per_capita_income | statefip + year, data = panel_data_clean2
)

summary(preliminary_model)


m_twfe <- feols(poverty_rate ~ min_wage + unemployment_rate + real_per_capita_income | statefip + year,
                data = panel_data_clean2,
                vcov = ~ statefip 
  
)
summary(m_twfe)
```

```{r}
colnames(panel_data_clean)
```

