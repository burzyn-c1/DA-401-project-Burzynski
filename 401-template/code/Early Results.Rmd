---
title: "DA 401 Early Results"
author: "Calvin Burzynski"
date: "2025-10-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(dplyr)
library(tidyr)
library(stringr)
library(lubridate)
library(readr)
library(ggplot2)
library(fixest)
library(janitor)
library(broom)
library(data.table)

#load in ipums (acs) dataset
ipums <- fread("../../../usa_00005.csv.gz") #used fread from the data.table package as the file is large and this allowed it to be loaded in much quicker

#load minimum wage DOL data
min_wage_data <- fread("..//../..//Minimum Wage from DOL 2010-2023.csv") #used fread to avoid X in front of year column names

#load monthly unemployment rate data
unemployment_rate_data <- read.csv("..//..//..//state_unemploy_panel_copy_paste.csv")

gdp_income <- read.csv("..//..//..//State Annual Summary Statistics GDP Income.csv", skip = 3)

cpi <- read_csv("../../../CPI_all_urban_import.csv") #got warning but data loaded in just fine

tail(ipums)
```


```{r}
#reusable visual theme for graphs 
theme_slide <- theme_minimal(base_size = 13) + 
  theme(
    plot.title.position = "plot",
    plot.title = element_text(face = "bold"), 
    plot.subtitle = element_text(margin = margin(b = 10)), 
    plot.caption = element_text(size = 9, color = "grey40"), 
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    axis.title.y = element_text(margin = margin(r = 8)),
    axis.title.x = element_text(margin = margin(t = 8)),
    legend.position = "bottom"
  )
```


```{r}
#filter for poverty status
ipums %>%
  distinct(POVERTY) %>%
  arrange(POVERTY) #investigating values of poverty 
summary(ipums$POVERTY)
summary(ipums$EMPSTAT)

```


```{r}
ipums_poverty <- ipums %>%
  filter(EMPSTAT == 1, UHRSWORK >= 35, WKSWORK2 >= 6, AGE >= 18, AGE <= 64) %>%
  mutate(POVERTY = as.numeric(POVERTY)) %>%
  mutate(in_poverty = case_when(
    is.na(POVERTY) ~ NA_real_,
    POVERTY < 100 ~ 1, 
    POVERTY >= 100 ~ 0
  ), 
    low_wage = if_else(POVERTY <= 150, 1L, 0L, missing = NA_integer_) #using 150 as the cutoff as most analyses go beyond strict poverty to include near-poor population. Many federal programs use 125 to 150% and my analysis focuses on poverty or near poverty populations
  ) %>%
  filter(low_wage == 1) %>%
  group_by(STATEFIP, YEAR) %>%
  summarise(
    poverty_rate = weighted.mean(in_poverty, w = PERWT, na.rm = T), 
    pop_weight = sum(PERWT, na.rm = T), 
    .groups = "drop"
  )
#pop_weight represents the estimated total number of individuals represented by the ACS sample in that state-year 
```


```{r}
min_wage_long <- min_wage_data %>%
  rename_with(~str_remove(., "^X"), starts_with("X")) %>% #cleans columns with 'X' prefix
  pivot_longer(
    cols = all_of(as.character(2010:2023)),
    names_to = "YEAR",
    values_to = "min_wage"
  ) %>%
  mutate(
    YEAR = as.numeric(YEAR)
  ) %>%
  filter(between(YEAR, 2010, 2023))
```


```{r}
gdp_income_long <- gdp_income %>%
  rename_with(~str_remove(., "^X"), starts_with("X")) %>%
  filter(LineCode %in% c(1, 8)) %>%
  select(GeoName, GeoFips, LineCode, all_of(as.character(2010:2023))) %>%
  pivot_longer(
    cols = all_of(as.character(2010:2023)),
    names_to = "YEAR",
    values_to = "value"
  ) %>%
  mutate(
    YEAR = as.integer(YEAR), 
    value = parse_number(as.character(value)),
    STATEFIP = as.integer(parse_number(as.character(GeoFips)) / 1000L), 
    var = case_when(
      LineCode == 1 ~ "real_gdp", 
      LineCode == 8 ~ "real_per_capita_income"
    )
  ) %>%
  filter(STATEFIP >0) %>%
  select(STATEFIP, YEAR, var, value, GeoName) %>%
  pivot_wider(names_from = var, values_from = value) %>%
  mutate(real_gdp = as.numeric(real_gdp), 
         real_per_capita_income = as.numeric(real_per_capita_income)
         )
```

```{r}
min_wage_long <- min_wage_long %>%
  rename(state=State) %>%
  rename(year=YEAR)#rename to get characters the same for merge

unemployment_with_fips <- unemployment_rate_data %>%
  left_join(
    min_wage_long %>%
      distinct(state, StateFIPS) %>%
      transmute(state, STATEFIP = as.integer(StateFIPS)), 
    by = "state"
  ) %>%
  transmute(STATEFIP, year, annual_unemp_sa)
```


```{r}
#filter out years within unemployment_with_fips
unemployment_with_fips <- unemployment_with_fips %>%
  filter(year > 2009 & year < 2024)

#rename columns for lowercase match
ipums_poverty <- ipums_poverty %>%
  rename(year=YEAR)
gdp_income_long <- gdp_income_long %>%
  rename(year=YEAR)
```

```{r}
#merging datasets
panel_data <- ipums_poverty %>%
  left_join(min_wage_long %>% transmute(STATEFIP = as.integer(StateFIPS), year, min_wage), 
            by = c("STATEFIP", "year")) %>%
  left_join(unemployment_with_fips, by = c("STATEFIP", "year")) %>%
  left_join(gdp_income_long, by = c("STATEFIP", "year"))


#filter out district of columbia
panel_clean <- panel_data %>%
  filter(STATEFIP != 11)

#summary of data
summary(panel_clean)
names(panel_clean)


```



```{r}
#check data distributions

#gdp 
ggplot(panel_clean, aes(x = real_gdp)) + geom_histogram(bins = 30, fill = "darkgreen", color = "black") + labs(title = "Distribution of GDP")

#income
ggplot(panel_clean, aes(x = real_per_capita_income)) + geom_histogram(bins = 30, fill = "darkblue", color = "white") + labs(title = "Distribution of Real Per Capita Income")

#minimum wage 
ggplot(panel_clean, aes(x = min_wage)) + geom_histogram(bins = 30, fill = "darkred", color = "white") + labs(title = "Distribution of Minimum Wage Across States")


#due to skewness of variables and common practice in research, some log transformations will be applied

#also creating dummy variable and log of one that looks okay distribution wise, but can be used down the line for robustness check
panel_clean2 <- panel_clean %>%
  mutate(log_gdp = log(pmax(real_gdp, 1)), 
         log_income = log(pmax(real_per_capita_income, 1)), 
         log_minw = log(pmax(min_wage, 1)), 
         treated_minw = as.integer(min_wage > 7.25))
  

#based on the scaling for poverty_rate, converting to a percent scale makes sense for ease of interpretability. 
panel_clean2 <- panel_clean2 %>%
  mutate(poverty_rate_pct = poverty_rate * 100)
```

```{r}
plot_data <- panel_clean2 %>%
  group_by(STATEFIP) %>%
  mutate(Group = ifelse(any(min_wage > 7.25), "Treated", "Control")) %>%
  ungroup()


ggplot(plot_data, aes(x = as.numeric(as.character(year)), y = poverty_rate_pct, color = Group)) + 
  stat_summary(fun = "mean", geom = "line", size = 1.2) + 
  stat_summary(fun = "mean", geom = "point", size = 2.5) + 
  labs(title = "Parallel Trends Check: Treated vs. Control States",
       subtitle = "Average poverty rates before and after minimum wage increases",
       x = "Year", y = "Mean Povery Rate", color = "Group") + 
  theme_minimal()

ggsave(filename = "parallel_trend_plot.png", dpi = 300)
```

The parallel trends plot compares the pre-treatment trajectories of mean poverty rates between states that enacted minimum wage increases (treated group) and those that did not ("control"). Prior to 2014, both groups follow roughly similar paths, with some variation around 2012 to 2014. Post-2014, both groups follow roughly similar paths, treated states exhibit a slightly higher level but maintain a broadly parallel movement, suggesting no sharp divergence in pre-trends. This visual evidence mostly supports the plausibility of parallel trends assumption required for difference-in-differences estimation, while indicating potential heterogeneity in post-treatment responses. 

```{r}
ggplot(panel_clean2, aes(x = poverty_rate_pct)) + geom_histogram(bins = 30, fill = "blue", color = "black") + labs(title = "Distribution of State-Year Poverty Rates")

```

```{r}
#poverty vs minimum wage
ggplot(panel_clean2, aes(x = log_minw, y = poverty_rate_pct)) + 
  geom_point(alpha = 0.6, color = "blue") + 
  geom_smooth(method = "lm", se = FALSE, color = "red", size = 1) + 
  labs(title = "Poverty vs. Minimum Wage", 
       x = "Log(Minimum Wage)", 
       y = "Poverty Rate") + theme_slide
```

The scatterplot shows a negative relationship between poverty rates and real per capita income across states and years. As income levels rise, poverty rates consistently decline, which aligns with economic theory that higher income improves household well-being and reduces the share of individuals living below the poverty threshold. The fitted regression line highlights a moderately strong downward slope, suggesting that even small proportional increases in per capita income are associated with measurable reductions in state-level poverty. This relationship provides early support for including real per capita income as a key control variable in assessing the effects of minimum wage policy on poverty.


```{r}
#poverty vs. income
ggplot(panel_clean2, aes(x = log_income, y = poverty_rate_pct)) +
  geom_point(alpha = 0.6, color = "black") + geom_smooth(method = "lm", se = FALSE, color = "orange", size = 1) + 
  labs(title = "Poverty (Percentage Points) vs Real Per Capita Income", x = "Log(Income)", y = "Poverty Rate") + theme_slide

ggsave(filename = "log_income_vs_poverty_rate.png", dpi = 400)
```

The relationship visualized between poverty rates and the log of minimum wage was also negative. though somewhat weaker and more dispersed than that observed for income. States with higher minimum wages generally exhibit lower poverty rates, but the wider scatter reflects that wage policy alone does not fully explain poverty variation across states. Still, the downward-sloping trend line indicates that increases in the minimum wage are correlated with lower poverty, supporting the hypothesis that higher wage floors can improve living standards for low-income workers. The visualization provides early evidence of the expected direction of the policy's impact. which will be tested more formally in the fixed-effects regressions. 

```{r}
panel_clean2 %>%
  group_by(treated_minw) %>%
  summarise(
    mean_poverty = mean(poverty_rate_pct, na.rm = T),
    mean_minw = mean(min_wage, na.rm = T),
    mean_income = mean(real_per_capita_income, na.rm = T),
    mean_unemp = mean(annual_unemp_sa, na.rm = T)
  )
```


```{r}
str(panel_clean2)
names(panel_clean2)

#function "feols" is having issues with finding STATEFIP even though it is in the dataset
vars_needed <- c("STATEFIP", "YEAR", "poverty_rate_pct", "log_minw", "log_income", "log_gdp",
                 "unemployment_rate", "pop_weight")
setdiff(vars_needed, names(panel_clean2)) #returned character(0) so no actual issues with names

#convert to factors
panel_clean2$YEAR <- as.factor(as.numeric(panel_clean2$year))
panel_clean2$STATEFIP <- as.factor(as.numeric(panel_clean2$year))

fe_model <- feols(
  poverty_rate_pct ~ log_minw + log_income + log_gdp + annual_unemp_sa | STATEFIP + year,
  data = panel_clean2,
  cluster = ~ STATEFIP,
  weights = ~ pop_weight,
)

summary(fe_model)

#polished results of fixed effects regression
etable(fe_model, digits = 3, title = "Fixed Effects Model: Poverty vs. Minimum Wage")
```

The fixed-effects regression results indicate that, after accounting for state and year differences as well as macroeconomic controls, increases in the minimum wage are associated with statistically significant reductions in poverty. Specifically, the coefficient on log (minimum wage) is -0.012 and significant at the 0.1% level, implying that a 1% rise in the minimum wage corresponds to roughly a 0.012 percentage decline in the poverty rate, holding other factors constant. Both log (income per capita) (-0.048) and log (GDP) (0.001) are significant, with the income coefficient confirming that higher household income substantially reduces poverty, while GDP's small positive coefficient suggests that aggregate growth alone does not necessarily translate into immediate poverty alleviation at the household level. The unemployment rate also shows a small but significant positive association with poverty, consistent with expectations that higher unemployment elevates economic hardship. With a within R-squared of 0.57, the model explains over half of the variation in state-level poverty across time, underscoring that while minimum wage policy has a measurable effect, labor market conditions and income growth remain the dominant influences on poverty reduction between 2018 and 2023.  

```{r}
coef_data <- tidy(fe_model, conf.int = T)

coef_data %>%
  filter(term == "log_minw") %>%
  ggplot(aes(x = term, y = estimate)) + 
  geom_point(color = "darkred", size = 3) + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2, color = "gray40") + 
  labs(title = "Effect of Log (Minimum Wage) on Poverty Rate", 
       x = "", y = "Estimated Coefficient") + theme_minimal()
``` 

The coefficient plot displays the estimated relationship between the log of minimum wage and the state-level poverty rate from the fixed effects regression. The red dot represents the point estimate, while the gray vertical line shows the 95% confidence interval. The estimate of approximately -0.012 indicates that, while holding constant real per capita income, real GDP, and unemployment, a 1% increase in the minimum wage is associated with roughly a 0.012 percentage point decrease in the poverty rate. Although the direction is negative

```{r}
coef_keep <- c("log_minw", "log_income", "log_gdp", "unemployment_rate")

coef_df <- tidy(fe_model, conf.int = T) %>%
  filter(term %in% coef_keep) %>%
  mutate(term = factor(term, 
                       levels = rev(coef_keep), 
                       labels = rev(c("Log (Min Wage)", "Log (Income Per Capita)", "Log (Real GDP)", "Unemployment Rate"))))

p_coef <- ggplot(coef_df, aes(x = term, y = estimate)) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = 0.8) + 
  coord_flip() + labs(
    title = "Fixed Effects Model Coefficients", 
    subtitle = "State & Year FE; clustered by state; pop-weighted", 
    x = NULL, 
    y = "Estimated effect on poverty rate (pp)"
  ) + theme_slide

ggplot(coef_df, aes(x = term, y = estimate)) + 
  geom_hline(yintercept = 0, linetype = "dashed") + 
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), size = 0.8) + 
  coord_flip() + labs(
    title = "Fixed Effects Model Coefficients", 
    subtitle = "State & Year FE; clustered by state; pop-weighted", 
    x = NULL, 
    y = "Estimated effect on poverty rate (pp)"
  ) + theme_slide

ggsave(filename = "Fixed_effects_coef_plot.png", dpi = 300)
```

The fixed effects model, estimated with state and year controls and weighted by person-level population weights, indicate that a 1% increase in the minimum wage is associated with an increase of approximately 1.18 percentage points in the poverty rate among low-income full-time workers. The relationship is marginally significant at the 5% significance level, though the direction of the effect is positive, suggesting that in this sample, states that raised their minimum wages saw slightly higher measured poverty rates within this subgroup, potentially reflecting composition effects of short-run employment adjustments. By contrast, the real per capita income coefficient is large and highly significant, as a 1% rise in average real per capita income is associated with a 8.6 percentage point decrease in poverty rate, confirming that broader income growth has a strong poverty-reducing impact. The coefficients on GDP and unemployment are not statistically significant once controlling for fixed effects, suggesting that these macroeconomic indicators explain relatively little of the within-state variation in poverty over time. 


